<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Lotsemagazin Analyse</title>
</head>
<body>

<h2>Vielen Dank fÃ¼r die UnterstÃ¼tzung</h2>
<p><strong>der Ersteller des Lotsemagazin</strong></p>

<hr>

<p>Lotsemagazin â€“ Analyse</p>

<input type="text" id="name" placeholder="Dein Name (freiwillig)"><br><br>

<label>
Feedback (obligatorisch):
<select id="feedback">
    <option value="">Bitte wÃ¤hlen</option>
    <option value="ğŸ˜">ğŸ˜ Sehr gut</option>
    <option value="ğŸ˜Š">ğŸ˜Š Gut</option>
    <option value="ğŸ˜">ğŸ˜ Neutral</option>
    <option value="ğŸ˜•">ğŸ˜• KÃ¶nnte besser sein</option>
    <option value="ğŸ˜">ğŸ˜ Schlecht</option>
    <option value="ğŸ˜¡">ğŸ˜¡ Sehr schlecht</option>
</select>
</label><br><br>

<!-- VollstÃ¤ndige AGB -->
<textarea readonly rows="10" style="width:80%;">
AGB / DatenschutzerklÃ¤rung fÃ¼r das Lotsemagazin:

1. Mit Klick auf â€Analyse sendenâ€œ erklÃ¤rst du dich einverstanden, dass dein Name, Feedback, Standort (sofern freigegeben) und IP-Adresse fÃ¼r das Lotsemagazin verwendet werden.

2. Die erhobenen Daten dienen ausschlieÃŸlich der Analyse und Verbesserung des Lotsemagazins und werden nicht an Dritte weitergegeben.

3. Die Teilnahme ist freiwillig. Du kannst jederzeit den Standortzugriff verweigern oder die Teilnahme abbrechen.

4. Die gespeicherten Daten werden nach Abschluss der Auswertung gelÃ¶scht, sofern keine gesetzliche Aufbewahrungspflicht besteht.

5. Mit der Zustimmung bestÃ¤tigst du, dass du die AGB gelesen und verstanden hast.
</textarea><br>

<label>
<input type="checkbox" id="agb">
Ich akzeptiere die AGB / DatenschutzerklÃ¤rung
</label><br><br>

<button onclick="sendAnalyse()">Analyse senden</button>

<p id="status"></p>

<script>
async function sendAnalyse() {
    const name = document.getElementById("name").value || "Anonym";
    const agbChecked = document.getElementById("agb").checked;
    const feedback = document.getElementById("feedback").value;

    if(feedback === ""){
        document.getElementById("status").innerText = "Bitte wÃ¤hle ein Feedback-Emoji aus.";
        return;
    }

    if(!agbChecked){
        document.getElementById("status").innerText = "Bitte akzeptiere die AGB / DatenschutzerklÃ¤rung.";
        return;
    }

    document.getElementById("status").innerText = "Analyse wird vorbereitetâ€¦";

    // Funktion um die Mail zu senden
    async function sendMail(lat, lon, acc){
        let ip = "unbekannt";
        try {
            const res = await fetch('https://api.ipify.org?format=json');
            const data = await res.json();
            ip = data.ip;
        } catch {}

        const body = `
Lotsemagazin Analyse

Name: ${name}
Feedback: ${feedback}
IP-Adresse: ${ip}

Ort:
Breitengrad: ${lat}
LÃ¤ngengrad: ${lon}
Genauigkeit: Â±${acc} Meter
Zeit: ${new Date().toLocaleString()}

Analyse:
Teilnehmer hat freiwillig Daten fÃ¼r das Lotsemagazin bereitgestellt.
        `;

        const mailtoLink = "mailto:mschoepfer@lotsebasel.onmicrosoft.com" +
                           "?subject=Lotsemagazin Analyse" +
                           "&body=" + encodeURIComponent(body);

        window.location.href = mailtoLink;
        document.getElementById("status").innerText = "Analyse wird im Mailprogramm vorbereitet âœ”ï¸";
    }

    // Geolocation abfragen
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
            pos => {
                const lat = pos.coords.latitude.toFixed(6);
                const lon = pos.coords.longitude.toFixed(6);
                const acc = pos.coords.accuracy;
                sendMail(lat, lon, acc);
            },
            () => {
                // Wenn Standort verweigert wird
                sendMail("nicht verfÃ¼gbar", "nicht verfÃ¼gbar", "n/a");
                document.getElementById("status").innerText += " (Standort nicht freigegeben)";
            }
        );
    } else {
        sendMail("nicht verfÃ¼gbar", "nicht verfÃ¼gbar", "n/a");
    }
}
</script>

</body>
</html>
